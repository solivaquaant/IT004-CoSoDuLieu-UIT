USE QLDP
 --Câu 1.
CREATE DATABASE QLDP

CREATE TABLE KHACHHANG
(
	MAKH VARCHAR(10) NOT NULL,
	TENKH VARCHAR(10),
	QUOCTICH VARCHAR(20),
	TUOI INT
)
ALTER TABLE KHACHHANG ALTER COLUMN TENKH VARCHAR(30)
CREATE TABLE PHONG
(
	SOPHONG VARCHAR(10) NOT NULL,
	LOAIPHONG VARCHAR(10) NOT NULL,
	GIAPHONG INT,
	TINHTRANG VARCHAR(20)
)

CREATE TABLE HOADON
(
	SOHD VARCHAR(10) NOT NULL,
	NGHD SMALLDATETIME,
	MAKH VARCHAR(10)
)

CREATE TABLE CTTP
(
	SOHD VARCHAR(10) NOT NULL,
	SOPHONG VARCHAR(10) NOT NULL,
	NGAYDEN SMALLDATETIME,
	NGAYDI SMALLDATETIME
)

--Tạo khóa chính, khóa ngoại
ALTER TABLE KHACHHANG ADD CONSTRAINT PK_KH PRIMARY KEY (MAKH)
ALTER TABLE PHONG ADD CONSTRAINT PK_PHONG PRIMARY KEY (SOPHONG)
ALTER TABLE HOADON ADD CONSTRAINT PK_HD PRIMARY KEY (SOHD)
ALTER TABLE CTTP ADD CONSTRAINT PK_CTDP PRIMARY KEY (SOHD, SOPHONG)


ALTER TABLE HOADON ADD CONSTRAINT FK_HOADON FOREIGN KEY (MAKH) REFERENCES KHACHHANG (MAKH)
ALTER TABLE CTTP ADD CONSTRAINT FK_CTTP_HD FOREIGN KEY (SOHD) REFERENCES HOADON (SOHD)
ALTER TABLE CTTP ADD CONSTRAINT FK_CTTP_P FOREIGN KEY (SOPHONG) REFERENCES PHONG (SOPHONG)

--Câu 2. Nhập dữ liệu
INSERT INTO KHACHHANG (MAKH, TENKH, QUOCTICH, TUOI) VALUES
('KH01','Nguyen Ba Thang','Viet Nam',28),
('KH02','Lin Lin','Trung Quoc',30),
('KH03','David John','My',19),
('KH04','John Monash','My',20),
('KH05','Lin Chu','Trung Quoc',21)

INSERT INTO PHONG (SOPHONG, LOAIPHONG, GIAPHONG, TINHTRANG) VALUES
('P001','Thuong',180000,'Booked'),
('P002','Vip',350000,'Available'),
('P003','Tot',270000,'Booked')

INSERT INTO HOADON (SOHD, NGHD, MAKH) VALUES
('0001','20180122','KH01'),
('0002','20180206','KH02'),
('0003','20180312','KH03'),
('0004','20180410','KH04')

INSERT INTO CTTP (SOHD, SOPHONG, NGAYDEN, NGAYDI) VALUES
('0001','P001','20180118','20180122'),
('0002','P003','20180130','20180204'),
('0003','P003','20180305','20180310'),
('0004','P001','20180406','20180410')

--Câu 3.
ALTER TABLE PHONG ADD CONSTRAINT CHK_LOAIPHONG CHECK 
((GIAPHONG>300000 AND LOAIPHONG ='Vip') 
OR (GIAPHONG BETWEEN 200000 AND 300000 AND LOAIPHONG ='Tot')
OR (GIAPHONG <200000 AND LOAIPHONG = 'Thuong'))

--Câu 4
CREATE TRIGGER TRG_HOADON
ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @NGAYDEN SMALLDATETIME, @NGHD SMALLDATETIME, @SOHD VARCHAR(10)
	SELECT @SOHD = SOHD, @NGHD = NGHD 
	FROM INSERTED
	SELECT @NGAYDEN = NGAYDEN
	FROM CTTP
	WHERE @SOHD = SOHD
	IF (@NGAYDEN > @NGHD)
	BEGIN
		PRINT 'LOI: NGAY DEN VA NGAY HOA DON KHONG PHU HOP!'
		ROLLBACK TRANSACTION
	END
END

CREATE TRIGGER TRG_CTTP
ON CTTP
FOR UPDATE
AS
BEGIN
	DECLARE @NGAYDEN SMALLDATETIME, @NGHD SMALLDATETIME, @SOHD VARCHAR(10)
	SELECT @NGAYDEN = NGAYDEN
	FROM INSERTED
	SELECT @NGHD = NGHD, @SOHD = SOHD
	FROM HOADON
	IF (@NGAYDEN > @NGHD)
	BEGIN
		PRINT 'LOI: UPDATE NGAY DEN VA NGAY HOA DON KHONG PHU HOP!'
		ROLLBACK TRANSACTION
	END
END

UPDATE CTTP
SET NGAYDEN = '20190118'
WHERE SOHD = '0001'

SELECT * FROM CTTP
--Câu 5.
SELECT *
FROM PHONG
WHERE TINHTRANG = 'Available'

--Câu 6.
SELECT SOHD, NGHD
FROM HOADON JOIN KHACHHANG ON HOADON.MAKH = KHACHHANG .MAKH
WHERE QUOCTICH NOT IN ('Viet Nam')

--Câu 7.
SELECT TOP 1 WITH TIES QUOCTICH, COUNT(*) Tong_so_khach
FROM KHACHHANG KH JOIN HOADON HD ON KH.MAKH = HD.MAKH
GROUP BY QUOCTICH
ORDER BY Tong_so_khach DESC

--Câu 8.
SELECT SOPHONG
FROM CTTP JOIN HOADON HD ON CTTP.SOHD = HD.SOHD
JOIN KHACHHANG KH ON KH.MAKH = HD.MAKH
WHERE QUOCTICH = 'Viet Nam'
EXCEPT
SELECT SOPHONG
FROM CTTP JOIN HOADON HD ON CTTP.SOHD = HD.SOHD
JOIN KHACHHANG KH ON KH.MAKH = HD.MAKH
WHERE QUOCTICH = 'Trung Quoc'