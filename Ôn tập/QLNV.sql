USE QLNV

CREATE DATABASE QLNV

--CAU 1.

CREATE TABLE NHANVIEN
(
	MANV VARCHAR(3) NOT NULL,
	HOTEN VARCHAR(40),
	NGSINH SMALLDATETIME,
	PHAI VARCHAR(3),
	DIACHI VARCHAR(50),
	MAPHG VARCHAR(2),
	LUONG MONEY
)

CREATE TABLE PHONGBAN
(
	MAPHG VARCHAR(2) NOT NULL,
	TENPHG VARCHAR(50),
	TRPHG VARCHAR(3),
	NGNC SMALLDATETIME
)

CREATE TABLE DEAN
(
	MADA VARCHAR(5) NOT NULL,
	TENDA VARCHAR(50),
	DDIEM_DA VARCHAR (50),
	MAPHG VARCHAR(2),
	NGBD_DK SMALLDATETIME,
	NGKT_DK SMALLDATETIME
)

CREATE TABLE PHANCONG 
(
	MANV VARCHAR(3) NOT NULL,
	MADA VARCHAR(5) NOT NULL,
	THOIGIAN INT
)

--KHAI BAO KHOA CHINH
ALTER TABLE NHANVIEN ADD CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV)
ALTER TABLE PHONGBAN ADD CONSTRAINT PK_PHONGBAN PRIMARY KEY (MAPHG)
ALTER TABLE DEAN ADD CONSTRAINT PK_DEAN PRIMARY KEY (MADA)
ALTER TABLE PHANCONG ADD CONSTRAINT PK_PHANCONG PRIMARY KEY (MANV, MADA)

--KHAI BAO KHOA NGOAI
ALTER TABLE PHONGBAN ADD CONSTRAINT FK_TRPHG FOREIGN KEY (TRPHG) REFERENCES NHANVIEN (MANV)
ALTER TABLE DEAN ADD CONSTRAINT FK_MAPHG FOREIGN KEY (MAPHG) REFERENCES PHONGBAN (MAPHG)
ALTER TABLE PHANCONG ADD CONSTRAINT FK_MANV FOREIGN KEY  (MANV) REFERENCES NHANVIEN (MANV)
ALTER TABLE PHANCONG ADD CONSTRAINT FK_MADA  FOREIGN KEY (MADA) REFERENCES DEAN (MADA)

--NHAP DU LIEU:
INSERT INTO NHANVIEN (MANV, HOTEN, NGSINH, PHAI, DIACHI, LUONG) VALUES
('001', 'Vuong Ngoc Quyen','19771022','Nu', '450 Trung Vuong, HaNoi',30000000),
('002','Nguyen Thanh Tu','19750109','Nam','731 Tran Hung Dao, Q1, TpHCM',25000000),
('003','Le Thi Nhan','19801218','Nu','291 Ho Van Hue, QPN, TpHCM',25000000),
('004','Dinh Ba Tien','19880109','Nam','638 Nguyen Van Cu, Q5, TpHCM',22000000),
('005','Bui Thuy Vu','19920719','Nam','332 Nguyen Thai Hoc, Q1, TpHCM',23000000)

UPDATE NHANVIEN SET MAPHG  = 'QL' WHERE MANV = '001'
UPDATE NHANVIEN SET MAPHG = 'NC' WHERE MANV IN ('002','004')
UPDATE NHANVIEN SET MAPHG = 'DH' WHERE MANV IN ('003','005'

INSERT INTO PHONGBAN (MAPHG, TENPHG,TRPHG, NGNC) VALUES
('QL','Quan Ly','001','20180522'),
('DH','Dieu Hanh','003','20201010'),
('NC','Nghien Cuu','002','20200315')
SELECT * FROM PHONGBAN

INSERT INTO DEAN (MADA, TENDA, DDIEM_DA, MAPHG, NGBD_DK, NGKT_DK) VALUES
('TH001','Tin hoc hoa 1','HANOI','NC','20180201','20190201'),
('TH002','Tin hoc hoa 2','TPHCM','NC','20180604','20190201'),
('DT001','Dao tao 1','NHATRANG','DH','20170201','20210201'),
('DT002','Dao tao 2','HANOI','DH','20170201','20210201')

INSERT INTO PHANCONG (MANV, MADA,THOIGIAN) VALUES
('001','TH001',30),
('001','TH002',12),
('002','TH001',10),
('002','TH002',10),
('002','DT001',10),
('002','DT002',10),
('003','TH001',37),
('004','DT001',22),
('004','DT002',10)

--CAU 2.
--CAU A.
ALTER TABLE NHANVIEN ADD CONSTRAINT CHK_LUONG_NC CHECK (NOT (MAPHG = 'NC' AND LUONG <= 20000000))

--CAU B.Nhân viên chỉ được phân công vào các đề án có ngày dự kiến bắt đầu thực hiện đề án 
--(NGBD_DK) lớn hơn ngày sinh của nhân viên đó (NGSINH). (1.0 điểm) 


--CAU 3.
--CAU A.
SELECT TENPHG 
FROM PHONGBAN PB JOIN NHANVIEN NV ON PB.MAPHG = NV.MAPHG
GROUP BY TENPHG
HAVING AVG(LUONG) >=24000000
ORDER BY TENPHG DESC

--CAU B.
SELECT HOTEN 
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
JOIN DEAN DA ON DA.MADA = PC.MADA
WHERE DA.MAPHG = (SELECT MAPHG FROM PHONGBAN WHERE TENPHG='Nghien Cuu')
AND DDIEM_DA = 'HANOI'

--CAU C.
SELECT HOTEN, COUNT(MADA) SODEAN
FROM NHANVIEN NV JOIN PHANCONG PC ON NV.MANV = PC.MANV
GROUP BY HOTEN

--CAU D.Tìm nhân viên (HOTEN) chỉ tham gia những đề án do phòng “Nghien Cuu” chủ trì. (1.0 
--điểm) 
SELECT DISTINCT NHANVIEN.HOTEN
FROM NHANVIEN
JOIN PHANCONG ON NHANVIEN.MANV = PHANCONG.MANV
JOIN DEAN ON PHANCONG.MADA = DEAN.MADA
WHERE DEAN.MAPHG IN (SELECT MAPHG FROM PHONGBAN WHERE TENPHG = 'Nghien Cuu')
AND NHANVIEN.MANV NOT IN (
    SELECT PHANCONG.MANV
    FROM PHANCONG
    JOIN DEAN ON PHANCONG.MADA = DEAN.MADA
    WHERE DEAN.MAPHG NOT IN (SELECT MAPHG FROM PHONGBAN WHERE TENPHG = 'Nghien Cuu')
)

--CAU E.
SELECT HOTEN FROM NHANVIEN WHERE NOT EXISTS
	(SELECT MADA FROM DEAN WHERE MAPHG = (SELECT MAPHG FROM PHONGBAN WHERE TENPHG = 'Dieu Hanh' AND NOT EXISTS 
		(SELECT * FROM PHANCONG WHERE PHANCONG.MANV = NHANVIEN.MANV AND PHANCONG.MADA = DEAN.MADA)))

--CAU F.
--SELECT TOP 1 WITH TIES NHANVIEN.MAPHG, TRPHG, COUNT(MANV) SLNV
--FROM NHANVIEN JOIN PHONGBAN ON NHANVIEN.MAPHG = PHONGBAN.MAPHG
--GROUP BY NHANVIEN.MAPHG, TRPHG
--ORDER BY SLNV DESC

SELECT TENPHG, HOTEN
FROM NHANVIEN JOIN PHONGBAN ON NHANVIEN.MAPHG = PHONGBAN.MAPHG
JOIN 
	(SELECT TOP 1 WITH TIES NHANVIEN.MAPHG, TRPHG, COUNT(MANV) SLNV
	FROM NHANVIEN JOIN PHONGBAN ON NHANVIEN.MAPHG = PHONGBAN.MAPHG
	GROUP BY NHANVIEN.MAPHG, TRPHG
	ORDER BY SLNV DESC) AS THONGKE
ON THONGKE.TRPHG = NHANVIEN.MANV